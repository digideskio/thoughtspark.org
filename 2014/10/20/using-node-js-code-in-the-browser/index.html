<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
        
    <title>ThoughtSpark.org - Using Node.js Code in the Browser</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Interesting stuff from the eyes of Jeremy Whitlock">
    <meta name="author" content="Jeremy Whitlock <jcscoobyrs@gmail.com>">

    <!-- Stylesheets -->
    <link href="http://thoughtspark.org/css/bootstrap.css" rel="stylesheet">
    <link href="http://thoughtspark.org/css/thoughtspark.org.css" rel="stylesheet">
    <link href="http://thoughtspark.org/css/bootstrap-responsive.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Google Analytics -->
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-8129913-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>

  <body>

    <div id="wrapper">
      <div class="navbar navbar-inverse navbar-fixed-top">
        <div class="navbar-inner">
          <div class="container-fluid">
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </a>
            <a class="brand" href="http://thoughtspark.org/">ThoughtSpark.org</a>
            <div class="nav-collapse collapse">
              <ul class="nav">
                <li class="">
                  <a href="http://thoughtspark.org/archives/">Archives</a></li>
                <li class="">
                  <a href="http://thoughtspark.org/tags/">Tags Index</a></li>
                <li class="">
                  <a href="http://thoughtspark.org/about-me/">About Me</a></li>
              </ul>
              <form class="navbar-search pull-right" id="cse-search-box" action="http://google.com/cse" target="_blank">
                <input type="hidden" name="cx" value="002070316934860344827:uskwlee9cfw" />
                <input type="hidden" name="ie" value="UTF-8" />
                <input type="text" class="search-query" name="q" placeholder="Search" />
              </form>
            </div>
          </div>
        </div>
      </div>

      <div class="container-fluid" id="content-wrapper">
        <div class="row-fluid">
  <div class="span8 offset2 content" id="content">
    <div class="row-fluid">
      <div class="span12">
        <div class="page-header">
  <h1><a href="http://thoughtspark.org/2014/10/20/using-node-js-code-in-the-browser/">Using Node.js Code in the Browser</a> <small>Posted on 2014/10/20 at 22:00</small></h1>
</div>
<div class="widget-row row-fluid">
  <div class="span9">
    
    <a href="http://thoughtspark.org/tags/browser/" class="tag-link"><span class="label label-info">browser</span></a>
    
    <a href="http://thoughtspark.org/tags/browserify/" class="tag-link"><span class="label label-info">browserify</span></a>
    
    <a href="http://thoughtspark.org/tags/javascript/" class="tag-link"><span class="label label-info">javascript</span></a>
    
    <a href="http://thoughtspark.org/tags/node-js/" class="tag-link"><span class="label label-info">node.js</span></a>
    
  </div>
  <div class="span3">
    <a href="https://twitter.com/share" class="twitter-share-button"
       data-url="http://thoughtspark.org/2014/10/20/using-node-js-code-in-the-browser/"
       data-text="Using Node.js Code in the Browser"
       
       data-hashtags="javascript node.js browser browserify"
       
       data-via="whitlockjc"
       data-count="none"
       data-lang="en">Tweet</a>
    <span class="g-plusone"
         data-size="medium"
         data-annotation="none"
         data-href="http://thoughtspark.org/2014/10/20/using-node-js-code-in-the-browser/"></span>
  </div>
</div>
<div class="article-content">
  <p>For the past few months, I&rsquo;ve been working on <a href="https://github.com/apigee-127/swagger-tools">swagger-tools</a>, a JavaScript library that exposes various
utilities for working with <a href="http://swagger.io">Swagger</a> documents.  Need a command line utility to validate your Swagger
document(s)?  swagger-tools has it.  Need an API for validating your Swagger document(s)?  swagger-tools has it.
Want to use your Swagger document(s) to validate your API requests or to wire up your request handlers?  swagger-tools
has it&hellip;and much more.  But this post isn&rsquo;t about swagger-tools, sorry for the shameless plug.</p>

<p>There might come a time when it might make sense to expose your Node.js module to the browser.  This happened recently
for swagger-tools and I learned a lot during the process.  My hope is that this will help shed some light on the
available options and what I believe is a pretty decent approach to this.</p>

<h3>Getting Started</h3>

<p>When I started this process, the first thing I did was look for existing projects that work in Node.js and the browser.
While the concept is simple, I wanted to see how some of the <em>professionals</em> do it.  Since I already use
<a href="https://lodash.com/">Lo-Dash</a>, I started there.  As expected, an <a href="http://en.wikipedia.org/wiki/Immediately-invoked_function_expression">immediately-invoked function expression</a> and a few
statements that check the environment to identify if the code is running in the browser or Node.js.  Pretty simple
stuff.  Just for due diligence, I looked at a few other projects and they all had the same recipe:</p>
<pre class="highlight javascript"><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// The code for YOUR_MODULE_NAME
</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">exports</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">module</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">exports</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">YOUR_MODULE_NAME</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">exports</span><span class="p">.</span><span class="nx">YOUR_MODULE_NAME</span> <span class="o">=</span> <span class="nx">YOUR_MODULE_NAME</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">YOUR_MODULE_NAME</span> <span class="o">=</span> <span class="nx">YOUR_MODULE_NAME</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">})(</span><span class="k">this</span><span class="p">);</span>
</pre>
<p>This example is quite simplistic but the purpose is to give you an example of how you might do this.  <em>(If you want a
good example of how to do this and also how to handle more of the JavaScript module environments, checkout how Lo-Dash
does it.  They were even nice enough to support <a href="https://github.com/tlrobinson/narwhal">Narwhal</a> and <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino">Rhino</a>!)</em>  Unfortunately for me, what
allowed these projects to use such a simple approach for writing code that works in both the browser and Node.js was a
luxury I did not have: These projects did not have any external dependencies, including no dependencies on any core
Node.js modules.</p>

<h3>The Problem</h3>

<p>Any time you have a Node.js module with dependencies, you can&rsquo;t just <em>port</em> your module to run in the browser.  You not
only have to worry about making your code working in the browser but you also have to make sure your dependencies and
their dependencies and so on run in the browser.  You will also need to do this for core Node.js modules, which can be
a daunting task.</p>

<p>Let&rsquo;s assume you can do this yourself, you now need to make sure your code can load modules in the browser and in
Node.js.  The problem is that the browser doesn&rsquo;t have a built-in <code>require</code> function for loading modules.  What do you
do?  Do you separate your source base into a Node.js modules that wires things up the Node.js way and a browser module
that wires this up the browser way and figure out some way to share code between them?  It&rsquo;s not as easy as it sounds.</p>

<h3>Enter Browserify</h3>

<p>Thankfully, there is an open source project called <a href="http://browserify.org/">Browserify</a> that handles all of this for you.  Changes
are good that if you started the same way I did, you likely ran across numerous posts mentioning Browserify already.
What Browserify does is:</p>

<blockquote>
<p>Browserify lets you require(&lsquo;modules&rsquo;) in the browser by bundling up all of your dependencies.</p>
</blockquote>

<p>That&rsquo;s a pretty simple explanation of what Browserify does.  It also helps solve most of the issues related to your
code, or code you depend on, using core Node.js modules.  <em>(For complete information on the Node.js core module
browser compatibility, view the <a href="https://github.com/substack/node-browserify#compatibility">Browserify compatibility documentation</a>.)</em></p>

<p>With Browserify, you can generate a browser bundle from your Node.js files/modules.  This means one source base for
Node.js and from that same source base, you can generate a working browser bundle.  I have used Browserify successfully
on my [carvoyant][carvoyant-js] library and <a href="https://github.com/apigee-127/swagger-tools">swagger-tools</a>.  During the development of each of these
projects, I am yet to need to break my source base up for the applicable parts that could/should run in the browser.
<em>(In swagger-tools, of course I do not include the Connect middleware in my browser bundle but that separation was due
to applicability and not because of some lack in Browserify.)</em></p>

<p>To avoid listing out the same examples and documentation Browserify uses to explain/justify its use, I suggest you
visit it&rsquo;s <a href="https://github.com/substack/node-browserify">documentation</a>.  Instead, I would like to share a few things I&rsquo;ve had to do while
using Browserify and a new trick I learned to build [Bower][bower] modules using Browserify, complete with dependency
management handled by Bower instead of having to bundle all dependencies with your brower bundle.</p>

<h3>Browserify Tips</h3>

<p>Making your Node.js module more browser friendly is an iterative process.  If you want to use Browserify to take your
Node.js module as-is and create a standalone browser module, it will do that.  But chances are good that your first
build will be huge, especially if you use any of the core Node.js modules.</p>

<h4>Trimming the Fat</h4>

<p>What I&rsquo;ve noticed when using Browserify is that I tend to start with a large browser bundle and I will then try to
figure out how, if it&rsquo;s even possible, to make my bundle smaller.  The reason your browser bundle is typically so large
is because Browserify will build a browser bundle that includes all of your dependencies in it.  <em>(Think of this as
analogous to the Uber JAR in the Java space or a static binary for C/C++/&hellip;)</em></p>

<p>To remove some of the size, some modules like Lo-Dash will allow you to cherry pick the actual module features you use
instead of requiring the whole Lo-Dash module.  Unfortunately, not all modules are as flexible Lo-Dash is.  Of course,
you can analyze you modules and see if you&rsquo;re importing large modules or unnecessary modules and refactor accordingly.</p>

<p>In the end, the biggest gain I&rsquo;ve seen is by instructing Browserify to not include certain dependencies where possible.
For example, let&rsquo;s say you depend on a module that already has a browser version available.  Bundling that module is no
longer a requirement because you can include it either using Bower or a CDN or by shipping their module with your code.</p>

<p>The way to do this isn&rsquo;t as obvious as you might thing.  If you look at the Browserify documentation, you might be
inclined to <code>exclude</code> or <code>ignore</code> certain files/modules.  This will definitely make your browser bundle smaller but the
bundle will not work when ran in the browser.  The reason for this is that excluded/ignored modules are replaced with
<code>undefined</code>/<code>{}</code> respectively.</p>

<p>To properly tell Browserify to exclude a module, and to do it in a way that in the browser you can resolve externally
provided dependencies, is to use a Browserify transform.  For this purpose, there are many options out there but the
best one I&rsquo;ve found is <a href="https://github.com/thlorenz/exposify">exposify</a>.  With exposify you can configure how Browserify will resolve modules that
are provided for you externally.  For example, if you were to load Lo-Dash using a <code>script</code> tag, you could tell exposify
that the <code>lodash</code> module could be provided by <code>_</code> global variable.  To see this in action, have a look at
<a href="https://github.com/apigee-127/swagger-tools/blob/master/gulpfile.js#L57">swagger-tools/gulpfile.js#L57</a>.  <em>(Long story short, exposify lets you avoid including
modules in your browser bundle and lets you resolve the runtime dependency by associating a module name with a global
variable by name.)</em></p>

<p>Thanks to Browserify and exposify, I could create a Bower module for swagger-tools and not include all of the required
dependencies with the generated browser bundle.  I was able to set the proper Bower dependencies for modules that had
a Bower module published and do the default Browserify thing by bundling the modules that did not.  This saved me
<em>708k</em> or <em>67%</em> of my file size for my development module and <em>48k</em> or <em>37%</em> for my minified production module.</p>

<p>Of course Browserify has transforms for the usual suspects when it comes to exclusion of source maps, minifcation,
uglification, etc.</p>

<h4>External Files</h4>

<p>One of the things I needed for swagger-tools was to include some JSON files with my module.  In Node.js land, this works
by default.  In Browserify land, you need to use another Browserify transform called <a href="https://github.com/substack/brfs">brfs</a>.  What brfs does is it
will find any place in your code where you <code>require</code> a file, <code>fs.readFile</code> or <code>fs.readFileSync</code> and it will inline that
file&rsquo;s contents into your module.  So if you were to <code>var schema = require(&#39;./path/to/schema.json&#39;)</code>, brfs will make it
so that in the browser bundle, <code>schema</code> is set to the string content of your <code>schema.json</code> file.</p>

<h4>Building Bundles</h4>

<p>As I mentioned above, Browserify builds standalone browser bundles.  I think in many cases, these large static binaries
can serve a purpose as they give you a completely safe environment for your module.  <em>(This is great for standalone
application binaries where you don&rsquo;t care if others use your code.)</em>  On the other hand, being able to leverage package
mangers to share your module and to create smaller binaries is nice as well.  I couldn&rsquo;t make my mind up so for
swagger-tools, I build both.  <em>(To see how I&rsquo;m building 4 binaries, two standalone binaries and two Bower binaries, for
swagger-tools, check out <a href="https://github.com/apigee-127/swagger-tools/blob/master/gulpfile.js#L35">swagger-tools/gulpfile.js#L35</a>.)</em></p>

<h3>Conclusion</h3>

<p>Browserify is a wonderful tool to make it very simple to have one code base for your Node.js module and your browser
module.  I find that Browserify was very unobstrusive and that given the right transform, I could basically do all of
the things I needed to build the browser bundle I required.  I realize that this was not some walk through or tutorial
but don&rsquo;t fret, the <a href="https://github.com/substack/node-browserify">Browserify Documentation</a> is very easy to read and understand.</p>

</div>
      </div>
    </div>
  </div>
</div><div class="row-fluid">
  <div class="span8 offset2 content" id="content">
    <div class="row-fluid">
      <div class="span12">
        <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'thoughtsparkorg'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

      </div>
    </div>
  </div>
</div>
      </div>
    </div>

    <div id="push"></div>

    <div id="footer">
      <div class="container-fluid">
        <p>© Jeremy Whitlock 2015 | Brought to you by <a href="http://pages.github.com/">GitHub Pages</a>,
          <a href="http://middlemanapp.com/">Middleman</a> and
          <a href="http://twitter.github.com/bootstrap/">Twitter Bootstrap</a>. |
          <a href="https://github.com/whitlockjc/thoughtspark.org">Site Sources</a>
        </p>
      </div>
    </div>

    <!-- JavaScript -->
    <script src="http://thoughtspark.org/js/jquery.js"></script>
    <script src="http://thoughtspark.org/js/bootstrap.js"></script>
    <script src="http://thoughtspark.org/js/thoughtspark.org.js"></script>
  </body>
</html>
