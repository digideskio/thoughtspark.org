<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
        
    <title>ThoughtSpark.org - Dropwizard and Jersey ExceptionMappers</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Interesting stuff from the eyes of Jeremy Whitlock">
    <meta name="author" content="Jeremy Whitlock <jcscoobyrs@gmail.com>">

    <!-- Stylesheets -->
    <link href="http://thoughtspark.org/css/bootstrap.css" rel="stylesheet">
    <link href="http://thoughtspark.org/css/thoughtspark.org.css" rel="stylesheet">
    <link href="http://thoughtspark.org/css/bootstrap-responsive.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Favicon and Touch Icons -->
    <!-- <link rel="shortcut icon" href="http://thoughtspark.org/img/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://thoughtspark.org/img/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://thoughtspark.org/img/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://thoughtspark.org/img/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="http://thoughtspark.org/img/apple-touch-icon-57-precomposed.png"> -->

    <!-- Google Analytics -->
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-8129913-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>

  <body>

    <div id="wrapper">
      <div class="navbar navbar-inverse navbar-fixed-top">
        <div class="navbar-inner">
          <div class="container-fluid">
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </a>
            <a class="brand" href="http://thoughtspark.org/">ThoughtSpark.org</a>
            <div class="nav-collapse collapse">
              <ul class="nav">
                <li class="">
                  <a href="http://thoughtspark.org/archives/">Archives</a></li>
                <li class="">
                  <a href="http://thoughtspark.org/tags/">Tags Index</a></li>
                <li class="">
                  <a href="http://thoughtspark.org/about-me/">About Me</a></li>
              </ul>
              <form class="navbar-search pull-right" id="cse-search-box" action="http://google.com/cse" target="_blank">
                <input type="hidden" name="cx" value="002070316934860344827:uskwlee9cfw" />
                <input type="hidden" name="ie" value="UTF-8" />
                <input type="text" class="search-query" name="q" placeholder="Search" />
              </form>
            </div>
          </div>
        </div>
      </div>

      <div class="container-fluid" id="content-wrapper">
        <div class="row-fluid">
          <div class="span8 offset2 content" id="content">
            <div class="row-fluid">
  <div class="span12">
    <div class="page-header">
  <h1><a href="http://thoughtspark.org/2013/02/25/dropwizard-and-jersey-exceptionmappers/">Dropwizard and Jersey ExceptionMappers</a> <small>Posted on 2013/02/25 at 12:00</small></h1>
</div>
<div class="widget-row row-fluid">
  <div class="span9">
    
    <a href="http://thoughtspark.org/tags/dropwizard/" class="tag-link"><span class="label label-info">dropwizard</span></a>
    
    <a href="http://thoughtspark.org/tags/java/" class="tag-link"><span class="label label-info">java</span></a>
    
    <a href="http://thoughtspark.org/tags/jersey/" class="tag-link"><span class="label label-info">jersey</span></a>
    
    <a href="http://thoughtspark.org/tags/json/" class="tag-link"><span class="label label-info">json</span></a>
    
  </div>
  <div class="span3">
    <a href="https://twitter.com/share" class="twitter-share-button"
       data-url="http://thoughtspark.org/2013/02/25/dropwizard-and-jersey-exceptionmappers/"
       data-text="Dropwizard and Jersey ExceptionMappers"
       
       data-hashtags="dropwizard java jersey json"
       
       data-via="whitlockjc"
       data-count="none"
       data-lang="en">Tweet</a>
    <span class="g-plusone"
         data-size="medium"
         data-annotation="none"
         data-href="http://thoughtspark.org/2013/02/25/dropwizard-and-jersey-exceptionmappers/"></span>
  </div>
</div>
<div class="article-content">
  <p>The past month I&#39;ve been using an <a href="http://en.wikipedia.org/wiki/Open_source_software">open source</a> project called
<a href="http://dropwizard.codahale.com/">Dropwizard</a>.  Dropwizard is a self-described as being a &ldquo;Java framework for
developing ops-friendly, high-performance, RESTful web services&rdquo;.  Dropwizard is an awesome piece of kit that bundles
best of breed Java tooling like <a href="http://www.eclipse.org/jetty/">Jetty</a>,
<a href="http://code.google.com/p/guava-libraries/">Guava</a> and <a href="http://jersey.java.net/">Jersey</a>.  Speaking of Jersey, this is
what I&#39;d like to talk about today, specifically about how Dropwizard exposes the ability to create your own Jersey
ExceptionMapper and how the built-in Dropwizard ExceptionMappers might cause you some grief, with a workaround.</p>

<h3>What is an ExceptionMapper?</h3>

<p>Jersey, or should I say <a href="http://jax-rs-spec.java.net/">JAX-RS</a>, exposes a mechanism that will allow you to map a thrown
Exception or Throwable to a REST response, instead of being unhandled and being presented to
the user as some stacktrace or error text.  <em>(This mechanism requires than you implement the generic
ExceptionMapper interface and then register it.)</em>  This is excellent for REST APIs that like to
return errors back to the client as part of using the API, like returning a <a href="http://www.json.org/">JSON</a> representation
of an Exception that can be parsed and handled on the client.</p>

<h3>Custom ExceptionMappers in Dropwizard</h3>

<p>My initial impression of Dropwizard in the context of Jersey and needing to register custom ExceptionMappers was very
positive since Dropwizard exposes an API for registering ExceptionMappers.  Here is a very brief example for those of
you looking to register your custom ExceptionMapper within Dropwizard:</p>
<div class="highlight"><pre><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">thoughtspark</span><span class="o">.</span><span class="na">dropwizard</span><span class="o">.</span><span class="na">app</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.thoughtspark.dropwizard.app.ApplicationConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.thoughtspark.dropwizard.app.GenericExceptionMapper</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.yammer.dropwizard.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.yammer.dropwizard.config.Bootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.yammer.dropwizard.config.Environment</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Example Dropwizard {@link Service}.</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApplicationService</span> <span class="kd">extends</span> <span class="n">Service</span><span class="o">&lt;</span><span class="n">ApplicationConfiguration</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="cm">/**</span>
<span class="cm">     * Entry point for running this services in isolation via Dropwizard.</span>
<span class="cm">     *</span>
<span class="cm">     * @param args the arguments</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="k">new</span> <span class="nf">ApplicationService</span><span class="o">().</span><span class="na">run</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * {@inheritDoc}</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">Bootstrap</span><span class="o">&lt;</span><span class="n">ApplicationConfiguration</span><span class="o">&gt;</span> <span class="n">bootstrap</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">bootstrap</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&quot;application&quot;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * {@inheritDoc}</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="n">ApplicationConfiguration</span> <span class="n">applicationConfiguration</span><span class="o">,</span> <span class="n">Environment</span> <span class="n">environment</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// Register the custom ExceptionMapper(s)</span>
        <span class="n">environment</span><span class="o">.</span><span class="na">addProvider</span><span class="o">(</span><span class="k">new</span> <span class="n">GenericExceptionMapper</span><span class="o">());</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre>
</div>

<p>The GenericExceptionMapper being registered will handle all Throwables thrown and return a JSON payload representing
the error and its message.</p>

<h3>Dropwizards Secret &ldquo;Gotcha&rdquo;</h3>

<p>Everything was going great until I started using Dropwizard
<a href="http://dropwizard.codahale.com/manual/core/#validation">Validation</a>.  I noticed that whenever my bean validation
failed, instead of seeing a JSON payload of my validation exception, I was always seeing an HTML version of the
exception&hellip;almost as if I never registered my custom ExceptionMapper, or maybe my custom ExceptionMapper just wasn&#39;t
working.  Seeing that all Exceptions extend Throwable, I didn&#39;t see how my ExceptionMapper wasn&#39;t configured properly
so I dropped into the debugger.</p>

<p>After some looking around, I see that the actual exception being throw was of type InvalidEntityException.  At this
point, I created a new ExceptionMapper specifically for the InvalidEntityException, restarted Dropwizard and it
worked!  Instead of the HTML responses for InvalidEntityExceptions, I saw my JSON representation.  Everything was
working great&hellip;that is until I restarted the server for a different reason and I noticed that the
InvalidEntityExceptions had gone back to HTML.  I knew I hadn&#39;t changed anything related to the ExceptionMapper so I
started debugging.  After being unable to get the debugger to hit any break points in my ExceptionMappers I started
looking into the Dropwizard sources, thank goodness for open source software, and that is when I saw something,
Dropwizard is registering its own ExceptionMapper for the InvalidEntityException.  What was still bugging me was why my
ExceptionMapper worked once and upon server restart it stopped working, without any changes to my code.  Once again I
found myself in the bowels of Dropwizard&#39;s source and that&#39;s when I found my problem.</p>

<p>Dropwizard is adding its custom ExceptionMappers into Jersey&#39;s singletons Set, a Set that does not guarantee order.
This explains why one time my ExceptionMapper would work and another time, the built-in Dropwizard ExceptionMapper
would work.  Now that we know the problem, below is one way to work around the problem:</p>
<div class="highlight"><pre><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">thoughtspark</span><span class="o">.</span><span class="na">dropwizard</span><span class="o">.</span><span class="na">app</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.thoughtspark.dropwizard.app.ApplicationConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.thoughtspark.dropwizard.app.GenericExceptionMapper</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.jaxrs.json.JsonParseExceptionMapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.jersey.api.core.ResourceConfig</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.yammer.dropwizard.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.yammer.dropwizard.config.Bootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.yammer.dropwizard.config.Environment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.yammer.dropwizard.jersey.InvalidEntityExceptionMapper</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Example Dropwizard {@link Service}.</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApplicationService</span> <span class="kd">extends</span> <span class="n">Service</span><span class="o">&lt;</span><span class="n">ApplicationConfiguration</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="cm">/**</span>
<span class="cm">     * Entry point for running this services in isolation via Dropwizard.</span>
<span class="cm">     *</span>
<span class="cm">     * @param args the arguments</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="k">new</span> <span class="nf">ApplicationService</span><span class="o">().</span><span class="na">run</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * {@inheritDoc}</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">Bootstrap</span><span class="o">&lt;</span><span class="n">ApplicationConfiguration</span><span class="o">&gt;</span> <span class="n">bootstrap</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">bootstrap</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&quot;application&quot;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * {@inheritDoc}</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="n">ApplicationConfiguration</span> <span class="n">applicationConfiguration</span><span class="o">,</span> <span class="n">Environment</span> <span class="n">environment</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// Remove all of Dropwizard&#39;s custom ExceptionMappers</span>
        <span class="n">ResourceConfig</span> <span class="n">jrConfig</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="na">getJerseyResourceConfig</span><span class="o">();</span>
        <span class="n">Set</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">dwSingletons</span> <span class="o">=</span> <span class="n">jrConfig</span><span class="o">.</span><span class="na">getSingletons</span><span class="o">();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">singletonsToRemove</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;();</span>

        <span class="k">for</span> <span class="o">(</span><span class="n">Object</span> <span class="n">s</span> <span class="o">:</span> <span class="n">dwSingletons</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="k">instanceof</span> <span class="n">ExceptionMapper</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;com.yammer.dropwizard.jersey.&quot;</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">singletonsToRemove</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">for</span> <span class="o">(</span><span class="n">Object</span> <span class="n">s</span> <span class="o">:</span> <span class="n">singletonsToRemove</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">jrConfig</span><span class="o">.</span><span class="na">getSingletons</span><span class="o">().</span><span class="na">remove</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// Register the custom ExceptionMapper(s)</span>
        <span class="n">environment</span><span class="o">.</span><span class="na">addProvider</span><span class="o">(</span><span class="k">new</span> <span class="n">GenericExceptionMapper</span><span class="o">());</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre>
</div>

<p>In the code above, I remove all Dropwizard ExceptionMappers so that I have complete control over how my application
renders Jersey Exceptions.  Now no matter how many times I restart the server, my custom ExceptionMapper will be used
and I can always expect JSON to be returned for Exceptions thrown on the server.  Of course, you might need to change
the approach above based on your needs but for this scenario, I just wanted any ExceptionMapper that Dropwizard
provided to be done away with so I could use my custom versions that returned JSON instead of HTML.</p>

<h3>Conclusion</h3>

<p>Dropwizard is awesome and anytime I have to write Java-based REST servers, I&#39;ll be using it.  I do question the
built-in ExceptionMappers, especially with their inability to be configured to output something other than the
hardcoded HTML, but with the workaround above, I don&#39;t have to be stuck because of them.  Please do not let this take
away from Dropwizard and if you get tired of having to use the workaround above, I&#39;m sure the team would welcome a
patch&hellip;if you beat me to it.</p>

</div>
  </div>
</div><div class="row-fluid">
  <div class="span12">
    <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'thoughtsparkorg'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

  </div>
</div>
          </div>
        </div>
      </div>
    </div>

    <div id="push"></div>

    <div id="footer">
      <div class="container-fluid">
        <p>© Jeremy Whitlock 2012 | Brought to you by <a href="http://pages.github.com/">GitHub Pages</a>,
          <a href="http://middlemanapp.com/">Middleman</a> and
          <a href="http://twitter.github.com/bootstrap/">Twitter Bootstrap</a>. |
          <a href="https://github.com/whitlockjc/thoughtspark.org">Site Sources</a>
        </p>
      </div>
    </div>

    <!-- JavaScript -->
    <script src="http://thoughtspark.org/js/jquery.js"></script>
    <script src="http://thoughtspark.org/js/bootstrap.js"></script>
    <script src="http://thoughtspark.org/js/thoughtspark.org.js"></script>
  </body>
</html>
