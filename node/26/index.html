<div class="alert alert-error">
This script has become so popular that I have moved it to [Bitbucket](http://bitbucket.org) to be able to properly
collaborate with the users.  Please submit your patches/bugs/requests at: https://bitbucket.org/whitlockjc/jw-tools
</div>

<h3>Background</h3>

<p>When building a <a href="http://subversion.apache.org">Subversion</a> server, people usually go for the setup that requires the
least amount of administrative overhead.  For many, especially in the enterprise where
<a href="http://en.wikipedia.org/wiki/Active_Directory">Active Directory</a> and <a href="http://en.wikipedia.org/wiki/OpenLDAP">OpenLDAP</a>
rule, this means hooking up <a href="http://httpd.apache.org">Apache</a> to a directory server to authenticate users via
<a href="http://en.wikipedia.org/wiki/LDAP">LDAP</a>.  The reason for such a setup is that you can use the same credentials that
log you into your computer, and other internal resources usually, to access Subversion.  One less set of credentials
for the user to remember and one less user data store for the administrator to maintain.  Initially, this scenario is
without any real disadvantage.  But once you want to start using your groups defined in your directory with
<a href="http://svnbook.red-bean.com/nightly/en/svn.serverconfig.pathbasedauthz.html">Subversion&#39;s authorization</a> (authz)
mechanism, you find one of the shortcomings of such a configuration.</p>

<h3>The Problem</h3>

<p>Subversion&#39;s authz architecture requires your group definitions to be defined within the authz file.  Subversion&#39;s
authz architecture is also unaware of third-party data stores for users/groups.  This means that if you do not define
your group within the authz file, Subversion will not know whether a user is a member of said group and will
ultimately tell you that you do not have access to a resource.  That being said, the current problem is that with
this server configuration, either you cannot harness group models defined in your directory server or you have to
manually synchronize your group models from your directory server to Subversion&#39;s authz file.  There are many
downsides to doing things this way:</p>

<ul>
<li>It&#39;s time consuming</li>
<li>It&#39;s easy to forget that changes have been made and need to be mirrored</li>
<li>It&#39;s very easy to make mistakes when doing it yourself</li>
<li>&hellip;</li>
</ul>

<p>So while using LDAP for Subversion authentication is a dream, things are not so nice when it comes to reusing your
group models for authz that are defined in your directory server.</p>

<h3>The Solution</h3>

<p>Well, it just so happens that I have a solution.  One that is repeatable, loss-less and can be easily setup using the
same information you used to configure Apache to authenticate your Subversion users.  The solution is the
<strong>LDAP Groups to Subversion Authz Groups Bridge</strong> script. <strong>(Note: This script, its license and a duplicate of this
documentation are attached to the bottom of this article.)</strong></p>

<p>The &ldquo;LDAP Groups to Subversion Authz Groups Bridge&rdquo; script is written in Python and, as mentioned before, does its work
in a loss-less fashion.  This means that while this script will take on the trouble of taking your groups models
defined in your directory server and reproducing them in a Subversion authz file, the script will not prohibit you from
creating group definitions within the authz file that are not defined in your directory server.  Tired of all of the
background?  Ready to see the script in action?  Let&#39;s go.</p>

<h3>The Implementation</h3>

<p>Implementing the &ldquo;LDAP Groups to Subversion Authz Groups Bridge&rdquo; is actually simple.  If you&#39;ve already configured
Apache to authenticate your Subversion users, which we will not be covering, you can honestly copy/paste pieces of the
Apache configuration into the script.  Before we go through an example though, there are a few prerequisites that you
need to have taken care of before the script will run:</p>

<ul>
<li>Install Python (http://www.python.org)</li>
<li>Install the python-ldap module (http://python-ldap.sourceforge.net)</li>
</ul>

<p>Now that we have those things out of the way, let&#39;s look at the help output of the script, just to get our bearings:</p>
<div class="highlight"><pre><span class="n">Usage</span><span class="o">:</span> <span class="n">sync_ldap_groups_to_svn_authz</span><span class="o">.</span><span class="na">py</span> <span class="o">[</span><span class="n">options</span><span class="o">]</span>

<span class="n">Options</span><span class="o">:</span>
  <span class="o">-</span><span class="n">h</span><span class="o">,</span> <span class="o">--</span><span class="n">help</span>            <span class="n">show</span> <span class="k">this</span> <span class="n">help</span> <span class="n">message</span> <span class="n">and</span> <span class="n">exit</span>
  <span class="o">-</span><span class="n">d</span> <span class="n">BIND_DN</span><span class="o">,</span> <span class="o">--</span><span class="n">bind</span><span class="o">-</span><span class="n">dn</span><span class="o">=</span><span class="n">BIND_DN</span>
                        <span class="n">The</span> <span class="n">DN</span> <span class="n">of</span> <span class="n">the</span> <span class="n">user</span> <span class="n">to</span> <span class="n">bind</span> <span class="n">to</span> <span class="n">the</span> <span class="n">directory</span> <span class="k">with</span>
  <span class="o">-</span><span class="n">p</span> <span class="n">BIND_PASSWORD</span><span class="o">,</span> <span class="o">--</span><span class="n">bind</span><span class="o">-</span><span class="n">password</span><span class="o">=</span><span class="n">BIND_PASSWORD</span>
                        <span class="n">The</span> <span class="n">password</span> <span class="k">for</span> <span class="n">the</span> <span class="n">user</span> <span class="n">specified</span> <span class="k">with</span> <span class="n">the</span> <span class="o">--</span><span class="n">bind</span><span class="o">-</span><span class="n">dn</span>
  <span class="o">-</span><span class="n">l</span> <span class="n">URL</span><span class="o">,</span> <span class="o">--</span><span class="n">url</span><span class="o">=</span><span class="n">URL</span>     <span class="n">The</span> <span class="n">url</span> <span class="o">(</span><span class="n">scheme</span><span class="o">://</span><span class="n">hostname</span><span class="o">:</span><span class="n">port</span><span class="o">)</span> <span class="k">for</span> <span class="n">the</span> <span class="n">directory</span>
                        <span class="n">server</span>
  <span class="o">-</span><span class="n">b</span> <span class="n">BASE_DN</span><span class="o">,</span> <span class="o">--</span><span class="n">base</span><span class="o">-</span><span class="n">dn</span><span class="o">=</span><span class="n">BASE_DN</span>
                        <span class="n">The</span> <span class="n">DN</span> <span class="n">at</span> <span class="n">which</span> <span class="n">to</span> <span class="n">perform</span> <span class="n">the</span> <span class="n">recursive</span> <span class="n">search</span>
  <span class="o">-</span><span class="n">g</span> <span class="n">GROUP_QUERY</span><span class="o">,</span> <span class="o">--</span><span class="n">group</span><span class="o">-</span><span class="n">query</span><span class="o">=</span><span class="n">GROUP_QUERY</span>
                        <span class="n">The</span> <span class="n">query</span><span class="o">/</span><span class="n">filter</span> <span class="n">used</span> <span class="n">to</span> <span class="n">identify</span> <span class="n">group</span> <span class="n">objects</span><span class="o">.</span>
                        <span class="o">[</span><span class="n">Default</span><span class="o">:</span> <span class="n">objectClass</span><span class="o">=</span><span class="n">group</span><span class="o">]</span>
  <span class="o">-</span><span class="n">m</span> <span class="n">GROUP_MEMBER_ATTRIBUTE</span><span class="o">,</span> <span class="o">--</span><span class="n">group</span><span class="o">-</span><span class="n">member</span><span class="o">-</span><span class="n">attribute</span><span class="o">=</span><span class="n">GROUP_MEMBER_ATTRIBUTE</span>
                        <span class="n">The</span> <span class="n">attribute</span> <span class="n">of</span> <span class="n">the</span> <span class="n">group</span> <span class="n">object</span> <span class="n">that</span> <span class="n">stores</span> <span class="n">the</span>
                        <span class="n">group</span> <span class="n">memberships</span><span class="o">.</span>  <span class="o">[</span><span class="n">Default</span><span class="o">:</span> <span class="n">member</span><span class="o">]</span>
  <span class="o">-</span><span class="n">u</span> <span class="n">USER_QUERY</span><span class="o">,</span> <span class="o">--</span><span class="n">user</span><span class="o">-</span><span class="n">query</span><span class="o">=</span><span class="n">USER_QUERY</span>
                        <span class="n">The</span> <span class="n">query</span><span class="o">/</span><span class="n">filter</span> <span class="n">used</span> <span class="n">to</span> <span class="n">identify</span> <span class="n">user</span> <span class="n">objects</span><span class="o">.</span>
                        <span class="o">[</span><span class="n">Default</span><span class="o">:</span> <span class="n">objectClass</span><span class="o">=</span><span class="n">user</span><span class="o">]</span>
  <span class="o">-</span><span class="n">i</span> <span class="n">USERID_ATTRIBUTE</span><span class="o">,</span> <span class="o">--</span><span class="n">userid_attribute</span><span class="o">=</span><span class="n">USERID_ATTRIBUTE</span>
                        <span class="n">The</span> <span class="n">attribute</span> <span class="n">of</span> <span class="n">the</span> <span class="n">user</span> <span class="n">object</span> <span class="n">that</span> <span class="n">stores</span> <span class="n">the</span>
                        <span class="n">userid</span> <span class="n">to</span> <span class="n">be</span> <span class="n">used</span> <span class="k">in</span> <span class="n">the</span> <span class="n">authz</span> <span class="n">file</span><span class="o">.</span>  <span class="o">[</span><span class="n">Default</span><span class="o">:</span> <span class="n">cn</span><span class="o">]</span>
  <span class="o">-</span><span class="n">z</span> <span class="n">AUTHZ_PATH</span><span class="o">,</span> <span class="o">--</span><span class="n">authz</span><span class="o">-</span><span class="n">path</span><span class="o">=</span><span class="n">AUTHZ_PATH</span>
                        <span class="n">The</span> <span class="n">path</span> <span class="n">to</span> <span class="n">the</span> <span class="n">authz</span> <span class="n">file</span> <span class="n">to</span> <span class="n">update</span><span class="o">/</span><span class="n">create</span>
  <span class="o">-</span><span class="n">q</span><span class="o">,</span> <span class="o">--</span><span class="n">quiet</span>           <span class="n">Suppress</span> <span class="n">logging</span> <span class="n">information</span>
</pre>
</div>

<p>Anything that has a &ldquo;[Default:&rdquo; string in its corresponding documentation is &ldquo;optional&rdquo; and can usually be omitted
when running against most directory servers.  The things that are not optional are things that you can get from your
Apache configuration.  Now that we have our bearings, let&#39;s see an example.</p>

<p>Let&#39;s pretend that I have a directory structure like this:</p>

<ul>
<li>Release Managers (CN=Release Managers,OU=Groups,DC=subversion,DC=thoughtspark,DC=org)
** Release Manager One (CN=Release Manager One,OU=Users,DC=subversion,DC=thoughtspark,DC=org)</li>
<li>Developers (CN=Developers,OU=Groups,DC=subversion,DC=thoughtspark,DC=org)
** Release Managers (CN=Release Managers,OU=Nested Groups,OU=Groups,DC=subversion,DC=thoughtspark,DC=org)
** Developer One (CN=Developer One,OU=Users,DC=subversion,DC=thoughtspark,DC=org)
** Developer Two (CN=Developer Two,OU=Users,DC=subversion,DC=thoughtspark,DC=org)
** Developer Three (CN=Developer Three,OU=Users,DC=subversion,DC=thoughtspark,DC=org)</li>
<li>Release Managers (CN=Release Managers,OU=Nested Groups,OU=Groups,DC=subversion,DC=thoughtspark,DC=org)
** Release Manager Two (CN=Release Manager Two,OU=Users,DC=subversion,DC=thoughtspark,DC=org)</li>
<li>Administrators (CN=Administrators,CN=Roles,DC=subversion,DC=thoughtspark,DC=org)
** Jeremy Whitlock (CN=Jeremy Whitlock,OU=Users,DC=subversion,DC=thoughtspark,DC=org)</li>
</ul>

<p>(Yes&hellip;I have two groups with the same name but in different locations. This will help showcase how the <strong>LDAP Groups
to Subversion Authz Groups Bridge</strong> handles this situation.)  I now want to run the script:</p>
<div class="highlight"><pre><span class="n">python</span> <span class="n">sync_ldap_groups_to_svn_authz</span><span class="p">.</span><span class="n">py</span> <span class="o">\</span>
  <span class="o">-</span><span class="n">d</span> &quot;<span class="n">CN</span><span class="p">=</span><span class="n">Jeremy</span> <span class="n">Whitlock</span><span class="p">,</span><span class="n">OU</span><span class="p">=</span><span class="n">Users</span><span class="p">,</span><span class="n">DC</span><span class="p">=</span><span class="n">subversion</span><span class="p">,</span><span class="n">DC</span><span class="p">=</span><span class="n">thoughtspark</span><span class="p">,</span><span class="n">DC</span><span class="p">=</span><span class="n">org</span>&quot; <span class="o">\</span>
  <span class="o">-</span><span class="n">l</span> &quot;<span class="n">ldap</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span>389&quot; <span class="o">\</span>
  <span class="o">-</span><span class="n">b</span> &quot;<span class="n">DC</span><span class="p">=</span><span class="n">subversion</span><span class="p">,</span><span class="n">DC</span><span class="p">=</span><span class="n">thoughtspark</span><span class="p">,</span><span class="n">DC</span><span class="p">=</span><span class="n">org</span>&quot; <span class="o">&gt;</span> <span class="n">svn_auth</span><span class="p">.</span><span class="n">txt</span>
</pre>
</div>

<p>You&#39;ll notice I didn&#39;t specify a password.  In this event, the script will prompt you, securely, for a password.  After
the script runs, as long as you didn&#39;t run with the &ldquo;-q&rdquo; flag, you should see output like this:</p>
<div class="highlight"><pre><span class="n">Successfully</span> <span class="n">bound</span> <span class="n">to</span> <span class="n">ldap</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span>389
4 <span class="n">groups</span> <span class="n">found</span><span class="p">.</span>
</pre>
</div>

<p>Okay, things ran smoothly.  (If you notice any <strong>[WARNING]</strong> output, just look at the message along side the warning to
see why.)  So what does the file look like?</p>
<div class="highlight"><pre><span class="k">[groups]</span>

<span class="c">### Start generated content: LDAP Groups to Subversion Authz Groups Bridge (2009/01/19 23:17:07) ###</span>
<span class="na">ReleaseManagers</span> <span class="o">=</span> <span class="s">Release Manager One</span>
<span class="na">Developers</span> <span class="o">=</span> <span class="s">@ReleaseManagers1, Developer Three, Developer Two, Developer One</span>
<span class="na">ReleaseManagers1</span> <span class="o">=</span> <span class="s">Release Manager Two</span>
<span class="na">Administrators</span> <span class="o">=</span> <span class="s">Jeremy Whitlock</span>

<span class="c">################################################################################</span>
<span class="c">###########   LDAP Groups to Subversion Authz Groups Bridge (Legend)  ##########</span>
<span class="c">################################################################################</span>
<span class="c">### ReleaseManagers = CN=Release Managers,OU=Groups,DC=subversion,DC=thoughtspark,DC=org</span>
<span class="c">### Developers = CN=Developers,OU=Groups,DC=subversion,DC=thoughtspark,DC=org</span>
<span class="c">### ReleaseManagers1 = CN=Release Managers,OU=Nested Groups,OU=Groups,DC=subversion,DC=thoughtspark,DC=org</span>
<span class="c">### Administrators = CN=Administrators,CN=Roles,DC=subversion,DC=thoughtspark,DC=org</span>
<span class="c">###############################################################################</span>

<span class="c">### End generated content: LDAP Groups to Subversion Authz Groups Bridge ###</span>
</pre>
</div>

<p>Here is a list of features, or things to realize, based on the output of this script:</p>

<ul>
<li>The &ldquo;[groups]&rdquo; section is created but only if necessary</li>
<li>All generated content is within known &ldquo;markers&rdquo; for loss-less regeneration</li>
<li>The header tells you when the file was last synchronized</li>
<li>Nested groups, of any level, are supported</li>
<li>Groups with the same name, but different locations, are supported</li>
<li>An easy-to-read legend is created for reference reasons</li>
</ul>

<p>Now that we&#39;ve seen a very simple example, let&#39;s see one more example of how we might take an Apache configuration and
turn that into a call to the &ldquo;LDAP Groups to Subversion Authz Groups Bridge&rdquo;.</p>

<p>Below we have a snippet of the important parts of an Apache configuration using LDAP for Subversion authentication:</p>
<div class="highlight"><pre><span class="p">...</span>
# <span class="n">The</span> <span class="n">distinguished</span> <span class="n">name</span> <span class="n">to</span> <span class="n">bind</span> <span class="n">to</span> <span class="n">the</span> <span class="n">directory</span> <span class="n">server</span>
<span class="n">AuthLDAPBindDN</span> &quot;<span class="n">CN</span><span class="p">=</span><span class="n">Jeremy</span> <span class="n">Whitlock</span><span class="p">,</span><span class="n">OU</span><span class="p">=</span><span class="n">Users</span><span class="p">,</span><span class="n">DC</span><span class="p">=</span><span class="n">subversion</span><span class="p">,</span><span class="n">DC</span><span class="p">=</span><span class="n">thoughtspark</span><span class="p">,</span><span class="n">DC</span><span class="p">=</span><span class="n">org</span>&quot;

# <span class="n">The</span> <span class="n">password</span> <span class="k">for</span> <span class="n">the</span> <span class="n">user</span> <span class="n">above</span>
<span class="n">AuthLDAPBindPassword</span> &quot;<span class="n">myP455w0rd</span>&quot;

# <span class="n">The</span> <span class="n">LDAP</span> <span class="n">query</span> <span class="n">url</span>
<span class="n">AuthLDAPURL</span> &quot;<span class="n">ldap</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span>389<span class="o">/</span><span class="n">DC</span><span class="p">=</span><span class="n">subversion</span><span class="p">,</span><span class="n">DC</span><span class="p">=</span><span class="n">thoughtspark</span><span class="p">,</span><span class="n">DC</span><span class="p">=</span><span class="n">org</span>?<span class="n">sAMAccountName</span>?<span class="n">sub</span>?<span class="p">(</span><span class="n">objectClass</span><span class="p">=</span><span class="n">user</span><span class="p">)</span>&quot;
<span class="p">...</span>
</pre>
</div>

<p>With the above information, Apache could connect to my theoretical Active Directory server and look for user objects.
The way Apache identifies user objects is by the &ldquo;objectClass&rdquo; attribute being set to &ldquo;user&rdquo;.  Once a user is found,
the <strong>sAMAccountName</strong> attribute is queried to see if it matches the user logging in.  Once the user is found, it is
authenticated.  That being said, let&#39;s parse this information and turn it into a successful call to the <strong>LDAP Groups
to Subversion Authz Groups Bridge</strong>:</p>
<div class="highlight"><pre><span class="n">python</span> <span class="n">sync_ldap_groups_to_svn_authz</span><span class="p">.</span><span class="n">py</span> <span class="o">\</span>
  <span class="o">-</span><span class="n">d</span> &quot;<span class="n">CN</span><span class="p">=</span><span class="n">Jeremy</span> <span class="n">Whitlock</span><span class="p">,</span><span class="n">OU</span><span class="p">=</span><span class="n">Users</span><span class="p">,</span><span class="n">DC</span><span class="p">=</span><span class="n">subversion</span><span class="p">,</span><span class="n">DC</span><span class="p">=</span><span class="n">thoughtspark</span><span class="p">,</span><span class="n">DC</span><span class="p">=</span><span class="n">org</span>&quot; <span class="o">\</span>
  <span class="o">-</span><span class="n">p</span> &quot;<span class="n">myP455w0rd</span>&quot; <span class="o">\</span>
  <span class="o">-</span><span class="n">l</span> &quot;<span class="n">ldap</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span>389&quot; <span class="o">\</span>
  <span class="o">-</span><span class="n">b</span> &quot;<span class="n">DC</span><span class="p">=</span><span class="n">subversion</span><span class="p">,</span><span class="n">DC</span><span class="p">=</span><span class="n">thoughtspark</span><span class="p">,</span><span class="n">DC</span><span class="p">=</span><span class="n">org</span>&quot; <span class="o">\</span>
  <span class="o">-</span><span class="nb">i</span> &quot;<span class="n">sAMAccountName</span>&quot; <span class="o">&gt;</span> <span class="n">svn_auth</span><span class="p">.</span><span class="n">txt</span>
</pre>
</div>

<p>The new things you see in this call that differ from the first call is that we are now looking for the
<strong>sAMAccountName</strong> attribute for the username instead of the &ldquo;cn&rdquo; attribute.  You also see that we can pass the
password as a command line argument.</p>

<h3>Summary</h3>

<p>So now that we&#39;ve seen how the script is ran, what is necessary to get it running and even a complete example, it&#39;s
now up to you to get this thing into your Subversion infrastructure.  Immediate ideas are to automate this with your
operating system&#39;s task scheduler and/or create a web interface to kick this script off on an as-needed basis.
Regardless of how you use it, the &ldquo;LDAP Groups to Subversion Authz Groups Bridge&rdquo; should make the error-prone, tedious
and easy-to-forget process of manually synchronizing your LDAP group models to Subversion&#39;s authz file much, much
easier.  It might even get so easy you forget that Subversion doesn&#39;t natively support LDAP groups.</p>

<h3>Change History</h3>

<ul>
<li>2009-01-22 - There was a bug when you didn&#39;t specify the -z flag and when the query returned no groups.  Version
1.0.1 has been produced as a result.</li>
<li>2009-04-15 - There was a bug introduced when reformatting the code that broke the nested groups support.  Version
1.0.2 has been produced as a result.</li>
</ul>
